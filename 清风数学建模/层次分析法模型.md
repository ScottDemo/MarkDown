# 层次分析法（简称AHP）

建模比赛中最基础的模型之一，其主要用于解决评价类问题（例如：选择哪种方案最好、哪位运动员或者员工表现的更优秀）

## 1. 评价类问题可以用打分来解决

使用打分法解决评价类问题，只需要我们补充完成下面这张表格即可：

![image-20200718225155599](https://gitee.com/ScottDemo/cloudimg/raw/master/清风数学建模/image-20200718225155599.png)

同颜色的单元格的和为1，它们表示的针对某一因素所占的权重。

### 1.1 解决评价类问题，首先要想到以下三个问题：

- 我们评价的目标是什么？
- 我们为了达到这个目标有哪几种可选的方案？
- 评价的准则或者说指标是什么？（我们根据什么东西来评价好坏）

搜索数据网站：

- 虫部落
- 谷歌搜索
- 微信搜索
- 知乎搜索

## 2. 如何确定权重

**问题：**

一次性考虑五个指标之间的关系，往往考虑不周

**解决方法：**

两个两个指标进行比较，最终根据两两比较的结果来推算出权重。

![image-20200718225032003](https://gitee.com/ScottDemo/cloudimg/raw/master/清风数学建模/image-20200718225032003.png)

![image-20200718225358314](https://gitee.com/ScottDemo/cloudimg/raw/master/清风数学建模/image-20200718225358314.png)

### 2.1 一致性检验

各行（各列）之间成倍数关系

若矩阵中的每个元素$a_{ij}>0$且满足$a_{ij} × a_{ji} = 1$，则我们称该矩阵为正互反矩阵。

在层次分析法中，我们构造的判断矩阵均是正互反矩阵。

若正互反矩阵满足$a_{ij} × a_{jk} = a_{ik}$，则我们称其为一致矩阵。

>**注意**：在使用判断矩阵求权重之前，必须对其进行一致性检验。

原理：检验我们构造的判断矩阵和一致矩阵是否有太大的差别。

![image-20200718231622641](https://gitee.com/ScottDemo/cloudimg/raw/master/清风数学建模/image-20200718231622641.png)

### 2.2 一致性检验的步骤

第一步：计算`一致性指标CI`
$$
CI = \frac{λ_{max}-n}{n-1}
$$
第二步：查找对应的`平均随机一致性指标RI`

|  n   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  10  |  11  |  12  |  13  |  14  |  15  |
| :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: |
|  RI  |  0   |  0   | 0.52 | 0.89 | 1.12 | 1.26 | 1.36 | 1.41 | 1.46 | 1.49 | 1.52 | 1.54 | 1.56 | 1.58 | 1.59 |

第三步：计算`一致性比例CR`
$$
CR = \frac{CI}{RI}
$$
如果CR < 0.1，则可认为判断矩阵的一致性可以接受；否则需要对判断矩阵进行修正。

### 2.3 算数平均法求权重

第一步：将判断矩阵按照列归一化（每个元素除以其所在列的和）

第二步：将归一化的各列相加（按行求和）

第三步：将相加后得到的向量中每个元素除以n即可得到权重向量

![image-20200718234424000](https://gitee.com/ScottDemo/cloudimg/raw/master/清风数学建模/image-20200718234424000.png)

### 2.4 几何平均法求权重

第一步：将A的元素按照行相乘得到一个新的列向量

第二步：将新的向量的每个分量开n次方

第三步：对该列向量进行归一化即可得到权重向量

![image-20200718234726321](https://gitee.com/ScottDemo/cloudimg/raw/master/清风数学建模/image-20200718234726321.png)

### 2.5 特征值法求权重

一致矩阵有一个特征值为n，其余特征值均为0.

另外，很容易得到，当特征值为n时，对应的特征向量刚好为$k[\frac{1}{a_{11}},\frac{1}{a_{12}},...,\frac{1}{a_{1n}}]^T(k≠0)$，这一特征向量刚好就是一致矩阵的第一列。

第一步：求出矩阵A的最大特征值以及其对应的特征向量

第二步：对求出的特征向量进行归一化即可得到我们的权重

## 3. 层次分析法

![image-20200719000028231](https://gitee.com/ScottDemo/cloudimg/raw/master/清风数学建模/image-20200719000028231.png)

### 3.1 层次分析法第一步

1. 分析系统中各因素之间的关系，建立系统的阶梯`层次结构`

![image-20200719000206001](https://gitee.com/ScottDemo/cloudimg/raw/master/清风数学建模/image-20200719000206001.png)

> 1. 使用smartArt生成
> 2. 使用专业软件：亿图图示

### 3.2 层次分析法第二步

2. 对于同一层的各元素关于上一层次中某一准则的重要性进行两两比较，构造两两比较矩阵（判断矩阵）

![image-20200719111534632](https://gitee.com/ScottDemo/cloudimg/raw/master/清风数学建模/image-20200719111534632.png)

### 3.3 层次分析法第三步

由判断矩阵计算被比较元素对于该准则的相对权重，并进行一致性检验（检验通过权重才能用）

> PS：为了保证结果的`稳健性`，本文采用三种方法分别求出了权重。

## 4. 层次分析法的局限性

1. 评价的决策层不能太多，太多的话n会很大，判断矩阵和一致矩阵差异可能会很大。
2. 如果决策层中指标是已知的，那么我们如何利用这些数据来使得评价的更加准确呢？

# 代码部分

## 1. matlab语法基础知识

```matlab
%% Matlab基本的小常识 
% (1)在每一行的语句后面加上分号(一定要是英文的哦;中文的长这个样子；)表示不显示运行结果
a = 3;
a = 5

% (2)多行注释:选中要注释的若干语句,快捷键Ctrl+R
% % % a = 3;
% % % a = 5

% (3)取消注释:选中要取消注释的语句,快捷键Ctrl+T
% 我想要取消注释下面这行
% 还有这一行

% clear可以清除工作区的所有变量
clear

% clc可以清除命令行窗口中的所有文本,让屏幕变得干净
clc

% 所以大家在很多代码开头，都会见到:
clear;clc   % 分号也用于区分行。
% 这两条一起使用，起到“初始化”的作用，防止之前的结果对新脚本文件（后缀名是 .m）产生干扰。

%% 输出和输入函数(disp 和 input)
% disp函数
% matlab中disp()就是屏幕输出函数，类似于c语言中的printf（）函数
disp('Hello World!')
a = [1,2,3]    %同一行中间用逗号分隔，也可以不用逗号，直接用空格
a = [1 2 3]
a = [1;2;3]  % 分号可以用来分隔每一行的元素
disp(a) 
% 注意，disp函数比较特殊，这里可要 分号，可不要分号哦
disp(a);
% matlab中两个字符串的合并有两种方法
% （1）strcat(str1,str2……,strn) 
strcat('字符串1','字符串2') 
strcat('字符串1','字符串2','字符串3') 
% （2）[str 1,str 2，……, str n]或[str1  str2  ……  strn]
['字符串1'  '字符串2']
['字符串1','字符串2']
['字符串1','字符串2','字符串3']

% 一个有用的字符串函数：num2str  将数字转换为字符串
c = 100
num2str(c)
disp(['c的取值为' num2str(c)])
disp(strcat('c的取值为', num2str(c)))

% input函数
% 一般我们会将输入的数、向量、矩阵、字符串等赋给一个变量，这里我们赋给A
A = input('请输入A：');
B = input('请输入B：')
% 注意观察工作区，并体会input后面加分号和不加分号的区别

%% sum函数
% （1）如果是向量（无论是行向量还是列向量），都是直接求和
E = [1,2,3]
sum(E)
E = [1;2;3]
sum(E)
% （2）如果是矩阵，则需要根据行和列的方向作区分
clc
E = [1,2;3,4;5,6]  % E = [1 2; 3 4; 5 6]   矩阵同行元素用逗号或者空格隔开，不同行之间用分号隔开
% a=sum(x); %按列求和(得到一个行向量）
a = sum(E)
a = sum(E,1)   % 维度dim = 1 表示按照列  dim=2表示按照行  默认dim=1  
% a=sum(x,2); %按行求和(得到一个列向量）
a = sum(E,2)
% a=sum(x(:));%对整个矩阵求和
a = sum(sum(E))
E(:)
a = sum(E(:))

%% 基础：matlab中如何提取矩阵中指定位置的元素？
% （1）取指定行和列的一个元素（输出的是一个值）
clc;A=[1 1 4 1/3 3;1 1 4 1/3 3;1/4 1/4 1 1/3 1/2;3 3 3 1 3;1/3 1/3 2 1/3 1];
A
A(2,1)
A(3,2)
% （2）取指定的某一行的全部元素（输出的是一个行向量）
clc;A
A(2,:)  % :表示取所有元素
A(5,:)
% （3）取指定的某一列的全部元素（输出的是一个列向量）
clc;A
A(:,1)
A(:,3)
% （4）取指定的某些行的全部元素（输出的是一个矩阵）
clc;A
A([2,5],:)      % 只取第二行和第五行（一共2行）
A(2:5,:)        % 取第二行到第五行（一共4行）
A(2:2:5,:)     % 取第二行和第四行 （从2开始，每次递增2个单位，到5结束）
1:3:10
1:3:9
10:-1:1
A(2:end,:)      % 取第二行到最后一行
A(2:end-1,:)    % 取第二行到倒数第二行
% （5）取全部元素(按列拼接的，最终输出的是一个列向量)
clc;A
A(:)

%% size函数
clc;
A = [1,2,3;4,5,6]
B = [1,2,3,4,5,6]
size(A)
size(B)
% size(A)函数是用来求矩阵A的大小的,它返回一个行向量，第一个元素是矩阵的行数，第二个元素是矩阵的列数
[r,c] = size(A)
% 将矩阵A的行数返回到第一个变量r，将矩阵的列数返回到第二个变量c
r = size(A,1)  %返回行数
c = size(A,2) %返回列数

%% repmat函数
% B = repmat(A,m,n):将矩阵A复制m×n块，即把A作为B的元素，B由m×n个A平铺而成。
A = [1,2,3;4,5,6]
B = repmat(A,2,1)
B = repmat(A,3,2)

%% Matlab中矩阵的运算
% MATLAB在矩阵的运算中，“*”号和“/”号代表矩阵之间的乘法与除法(A/B = A*inv(B))
A = [1,2;3,4]
B = [1,0;1,1]
A * B
inv(B)  % 求B的逆矩阵
B * inv(B)
A * inv(B)
A / B

% 两个形状相同的矩阵对应元素之间的乘除法需要使用“.*”和“./”
A = [1,2;3,4]
B = [1,0;1,1]
A .* B
A ./ B

% 每个元素同时和常数相乘或相除操作都可以使用
A = [1,2;3,4]
A * 2
A .* 2
A / 2 
A ./ 2

% 每个元素同时乘方时只能用 .^
A = [1,2;3,4]
A .^ 2
A ^ 2 
A * A

%% Matlab中求特征值和特征向量
% 在Matlab中，计算矩阵A的特征值和特征向量的函数是eig(A),其中最常用的两个用法：
A = [1 2 3 ;2 2 1;2 0 3]
% （1）E=eig(A)：求矩阵A的全部特征值，构成向量E。
E=eig(A)
% （2）[V,D]=eig(A)：求矩阵A的全部特征值，构成对角阵D，并求A的特征向量构成V的列向量。（V的每一列都是D中与之相同列的特征值的特征向量）
[V,D]=eig(A)

%% find函数的基本用法
% 下面例子来自博客：https://www.cnblogs.com/anzhiwu815/p/5907033.html 博客内有更加深入的探究
% find函数，它可以用来返回向量或者矩阵中不为0的元素的位置索引。
clc;
X = [1 0 4 -3 0 0 0 8 6]
ind = find(X)
% 其有多种用法，比如返回前2个不为0的元素的位置：
ind = find(X,2)

%上面针对的是向量（一维），若X是一个矩阵（二维，有行和列），索引该如何返回呢？
clc;X = [1 -3 0;0 0 8;4 0 6]
ind = find(X)
% 这是因为在Matlab在存储矩阵时，是一列一列存储的，我们可以做一下验证：
X(4)
% 假如你需要按照行列的信息输出该怎么办呢？
[r,c] = find(X)
[r,c] = find(X,1) %只找第一个非0元素


%% 矩阵与常数的大小判断运算
% 共有三种运算符：大于> ;小于< ;等于 ==  （一个等号表示赋值；两个等号表示判断）
clc
X = [1 -3 0;0 0 8;4 0 6]
X > 0
X == 4

%% 判断语句
% Matlab的判断语句，if所在的行不需要冒号，语句的最后一定要以end结尾 ；中间的语句要注意缩进。
a = input('请输入考试分数:')
if a >= 85
    disp('成绩优秀')
elseif a >= 60 
    disp('成绩合格')
else
    disp('成绩挂科')
end


% % 注意：代码文件仅供参考，一定不要直接用于自己的数模论文中
% % 国赛对于论文的查重要求非常严格，代码雷同也算作抄袭
% % 如何修改代码避免查重的方法：https://www.bilibili.com/video/av59423231
```

## 2. 层次分析法代码

```matlab
%% 注意：在论文写作中，应该先对判断矩阵进行一致性检验，然后再计算权重，因为只有判断矩阵通过了一致性检验，其权重才是有意义的。
%% 在下面的代码中，我们先计算了权重，然后再进行了一致性检验，这是为了顺应计算过程，事实上在逻辑上是说不过去的。
%% 因此大家自己写论文中如果用到了层次分析法，一定要先对判断矩阵进行一致性检验。
%% 而且要说明的是，只有非一致矩阵的判断矩阵才需要进行一致性检验。
%% 如果你的判断矩阵本身就是一个一致矩阵，那么就没有必要进行一致性检验。

%% 输入判断矩阵
clear;clc
disp('请输入判断矩阵A： ')
% A = input('判断矩阵A=')
A =[1 1 4 1/3 3;
 1 1 4 1/3 3;
 1/4 1/4 1 1/3 1/2;
 3 3 3 1 3;
 1/3 1/3 2 1/3 1]
% matlab矩阵有两种写法，可以直接写到一行:
% [1 1 4 1/3 3;1 1 4 1/3 3;1/4 1/4 1 1/3 1/2;3 3 3 1 3;1/3 1/3 2 1/3 1]
% 也可以写成多行:
[1 1 4 1/3 3;
 1 1 4 1/3 3;
 1/4 1/4 1 1/3 1/2;
 3 3 3 1 3;
 1/3 1/3 2 1/3 1]
% 两行之间以分号结尾（最后一行的分号可加可不加），同行元素之间以空格（或者逗号）分开。

%% 方法1：算术平均法求权重
% 第一步：将判断矩阵按照列归一化（每一个元素除以其所在列的和）
Sum_A = sum(A)

[n,n] = size(A)  % 也可以写成n = size(A,1)
% 因为我们的判断矩阵A是一个方阵，所以这里的r和c相同，我们可以就用同一个字母n表示
SUM_A = repmat(Sum_A,n,1)   %repeat matrix的缩写
% 另外一种替代的方法如下：
    SUM_A = [];
    for i = 1:n   %循环哦，这一行后面不能加冒号（和Python不同），这里表示循环n次
        SUM_A = [SUM_A; Sum_A]
    end
clc;A
SUM_A
Stand_A = A ./ SUM_A
% 这里我们直接将两个矩阵对应的元素相除即可

% 第二步：将归一化的各列相加(按行求和)
sum(Stand_A,2)

% 第三步：将相加后得到的向量中每个元素除以n即可得到权重向量
disp('算术平均法求权重的结果为：');
disp(sum(Stand_A,2) / n)
% 首先对标准化后的矩阵按照行求和，得到一个列向量
% 然后再将这个列向量的每个元素同时除以n即可（注意这里也可以用./哦）

%% 方法2：几何平均法求权重
% 第一步：将A的元素按照行相乘得到一个新的列向量
clc;A
Prduct_A = prod(A,2)
% prod函数和sum函数类似，一个用于乘，一个用于加  dim = 2 维度是行

% 第二步：将新的向量的每个分量开n次方
Prduct_n_A = Prduct_A .^ (1/n)
% 这里对每个元素进行乘方操作，因此要加.号哦。  ^符号表示乘方哦  这里是开n次方，所以我们等价求1/n次方

% 第三步：对该列向量进行归一化即可得到权重向量
% 将这个列向量中的每一个元素除以这一个向量的和即可
disp('几何平均法求权重的结果为：');
disp(Prduct_n_A ./ sum(Prduct_n_A))

%% 方法3：特征值法求权重
% 第一步：求出矩阵A的最大特征值以及其对应的特征向量
clc
[V,D] = eig(A)    %V是特征向量, D是由特征值构成的对角矩阵（除了对角线元素外，其余位置元素全为0）
Max_eig = max(max(D)) %也可以写成max(D(:))哦~
% 那么怎么找到最大特征值所在的位置了？ 需要用到find函数，它可以用来返回向量或者矩阵中不为0的元素的位置索引。
% 那么问题来了，我们要得到最大特征值的位置，就需要将包含所有特征值的这个对角矩阵D中，不等于最大特征值的位置全变为0
% 这时候可以用到矩阵与常数的大小判断运算
D == Max_eig
[r,c] = find(D == Max_eig , 1)
% 找到D中第一个与最大特征值相等的元素的位置，记录它的行和列。

% 第二步：对求出的特征向量进行归一化即可得到我们的权重
V(:,c)
disp('特征值法求权重的结果为：');
disp( V(:,c) ./ sum(V(:,c)) )
% 我们先根据上面找到的最大特征值的列数c找到对应的特征向量，然后再进行标准化。

%% 计算一致性比例CR
clc
CI = (Max_eig - n) / (n-1);
RI=[0 0 0.52 0.89 1.12 1.26 1.36 1.41 1.46 1.49 1.52 1.54 1.56 1.58 1.59];  %注意哦，这里的RI最多支持 n = 15
CR=CI/RI(n);
disp('一致性指标CI=');disp(CI);
disp('一致性比例CR=');disp(CR);
if CR<0.10
    disp('因为CR < 0.10，所以该判断矩阵A的一致性可以接受!');
else
    disp('注意：CR >= 0.10，因此该判断矩阵A需要进行修改!');
end


% % 注意：代码文件仅供参考，一定不要直接用于自己的数模论文中
% % 国赛对于论文的查重要求非常严格，代码雷同也算作抄袭
% % 如何修改代码避免查重的方法：https://www.bilibili.com/video/av59423231
```





















